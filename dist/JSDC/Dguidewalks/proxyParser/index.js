import{__extends as t,__awaiter as e,__generator as r,__assign as n}from"../../../node_modules/tslib/tslib.es6.js";import i from"./AbsctractArticleProxyParser.js";import l from"axios";var o=function(i){function o(t){return i.call(this,t)||this}return t(o,i),o.prototype.getAll=function(t){return e(this,void 0,void 0,(function(){var t;return r(this,(function(e){switch(e.label){case 0:return this.cache.hasArticles()?[2,this.cache.articles]:[4,this.getArticlesFromAPI()];case 1:return t=e.sent(),this.cache.summaryMap=t.reduce((function(t,e){return t[e.title]=e,t}),{}),[2,t]}}))}))},o.prototype.getDetailByTitle=function(t,i){return e(this,void 0,void 0,(function(){var e,i,l,o,u;return r(this,(function(r){switch(r.label){case 0:return e=this.cache.summaryMap[t],i=this.cache.externalMap[t],l=!!e,o=this.cache.hasExternalKey(t),l?o?[2,n(n({},e),i)]:[4,this.getExternalDetailFromAPI(t)]:[3,2];case 1:return u=r.sent(),this.cache.externalMap[t]=u,[2,n(n({},e),u)];case 2:throw new Error("failed to get by title: ".concat(t,", get all article first"))}}))}))},o.prototype.getArticlesFromHTML=function(t){return Array.from(t.querySelectorAll(".sppb-addon-article")).map((function(t){var e,r,n;return{title:(null===(e=t.querySelector("h3"))||void 0===e?void 0:e.innerText)||"null",content:(null===(r=t.querySelector(".sppb-article-introtext"))||void 0===r?void 0:r.innerHTML)||"null",imgSrc:t.querySelector("a img").src||"null",link:(null===(n=t.querySelector("a"))||void 0===n?void 0:n.href)||"null"}}))},o.prototype.getArticlesFromAPI=function(){return e(this,void 0,void 0,(function(){var t,n,i,o=this;return r(this,(function(u){switch(u.label){case 0:return u.trys.push([0,3,,4]),[4,Promise.all(this.apiUrls.map((function(t){return l.get(t).catch((function(e){return console.error("Error fetching from ".concat(t,":"),e),null}))})))];case 1:return t=u.sent(),n=t.filter((function(t){return null!==t})).flatMap((function(t){return t.data.data})).filter((function(t){return o.cmsPath.some((function(e){var r;return null===(r=t.attributes.path)||void 0===r?void 0:r.alias.includes(e)}))})).sort((function(t,e){var r,n;return parseInt((null===(r=t.attributes.title.match(/^\d+/))||void 0===r?void 0:r[0])||"0")-parseInt((null===(n=e.attributes.title.match(/^\d+/))||void 0===n?void 0:n[0])||"0")})),[4,Promise.all(n.map((function(t){return e(o,void 0,void 0,(function(){var e,n,i,o,u,a,s,c,d,h,f,v;return r(this,(function(r){switch(r.label){case 0:if(e=t.attributes.title||"null",(n=(null===(s=t.attributes.body)||void 0===s?void 0:s.summary)||"null").length>34&&(n=n.substring(0,34)+"......"),i="https://dguidedwalks.tw".concat((null===(c=t.attributes.path)||void 0===c?void 0:c.alias)||""),o="null",!(null===(v=null===(f=null===(h=null===(d=t.relationships)||void 0===d?void 0:d.field_listing_image)||void 0===h?void 0:h.links)||void 0===f?void 0:f.related)||void 0===v?void 0:v.href))return[3,4];r.label=1;case 1:return r.trys.push([1,3,,4]),[4,l.get(t.relationships.field_listing_image.links.related.href)];case 2:return u=r.sent(),o="https://dguidedwalks.tw".concat(u.data.data.attributes.uri.url),[3,4];case 3:return a=r.sent(),console.error("Error fetching image:",a),[3,4];case 4:return[2,{title:e,content:n,imgSrc:o,link:i}]}}))}))})))];case 2:return[2,u.sent()];case 3:return i=u.sent(),console.error("Error fetching articles:",i),[2,[]];case 4:return[2]}}))}))},o.prototype.getExternalDetailFromHTML=function(t){var e,r,n,i=null===(e=t.querySelector(".sppb-addon-content p.d-h3"))||void 0===e?void 0:e.innerText;return{subtitle:null===(r=t.querySelector(".entry-header .tags"))||void 0===r?void 0:r.innerText,ref:null===(n=t.querySelector(".sppb-addon-content p:nth-child(4) span"))||void 0===n?void 0:n.innerText,content:i}},o.prototype.getExternalDetailFromAPI=function(t){var n;return e(this,void 0,void 0,(function(){var e,i,o,u,a,s,c;return r(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,Promise.all(this.apiUrls.map((function(t){return l.get(t).catch((function(e){return console.error("Error fetching from ".concat(t,":"),e),null}))})))];case 1:return e=r.sent(),i=e.filter((function(t){return null!==t})).flatMap((function(t){return t.data.data})),(o=i.find((function(e){return e.attributes.title===t})))?(u=o.attributes.title||"null",a="撰稿者：".concat(o.attributes.field_listing_author)||"null",s=(null===(n=o.attributes.body)||void 0===n?void 0:n.summary)||"null",[2,{subtitle:u,ref:a,content:s}]):[2,{subtitle:"null",ref:"null",content:"null"}];case 2:return c=r.sent(),console.error("Error fetching external detail:",c),[2,{subtitle:"null",ref:"null",content:"null"}];case 3:return[2]}}))}))},o}(i);export{o as default};
//# sourceMappingURL=index.js.map
