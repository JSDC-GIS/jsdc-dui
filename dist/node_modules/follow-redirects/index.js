import{f as t}from"../../_virtual/index4.js";import e from"url";import r from"http";import o from"https";import s from"stream";import i from"assert";import n from"./debug.js";var h,a,u,c=e,p=c.URL,d=r,f=o,_=s.Writable,l=i,m=n;h="undefined"!=typeof process,a="undefined"!=typeof window&&"undefined"!=typeof document,u=N(Error.captureStackTrace),h||!a&&u||console.warn("The follow-redirects package should be excluded from browser builds.");var R=!1;try{l(new p(""))}catch(t){R="ERR_INVALID_URL"===t.code}var v=["auth","host","hostname","href","path","pathname","port","protocol","query","search","hash"],y=["abort","aborted","connect","error","socket","timeout"],g=Object.create(null);y.forEach((function(t){g[t]=function(e,r,o){this._redirectable.emit(t,e,r,o)}}));var b=D("ERR_INVALID_URL","Invalid URL",TypeError),w=D("ERR_FR_REDIRECTION_FAILURE","Redirected request failed"),E=D("ERR_FR_TOO_MANY_REDIRECTS","Maximum number of redirects exceeded",w),q=D("ERR_FR_MAX_BODY_LENGTH_EXCEEDED","Request body larger than maxBodyLength limit"),L=D("ERR_STREAM_WRITE_AFTER_END","write after end"),T=_.prototype.destroy||x;function B(t,e){_.call(this),this._sanitizeOptions(t),this._options=t,this._ended=!1,this._ending=!1,this._redirectCount=0,this._redirects=[],this._requestBodyLength=0,this._requestBodyBuffers=[],e&&this.on("response",e);var r=this;this._onNativeResponse=function(t){try{r._processResponse(t)}catch(t){r.emit("error",t instanceof w?t:new w({cause:t}))}},this._performRequest()}function O(t){var e={maxRedirects:21,maxBodyLength:10485760},r={};return Object.keys(t).forEach((function(o){var s=o+":",i=r[s]=t[o],n=e[o]=Object.create(i);Object.defineProperties(n,{request:{value:function(t,o,i){var n;return n=t,p&&n instanceof p?t=U(t):I(t)?t=U(k(t)):(i=o,o=j(t),t={protocol:s}),N(o)&&(i=o,o=null),(o=Object.assign({maxRedirects:e.maxRedirects,maxBodyLength:e.maxBodyLength},t,o)).nativeProtocols=r,I(o.host)||I(o.hostname)||(o.hostname="::1"),l.equal(o.protocol,s,"protocol mismatch"),m("options",o),new B(o,i)},configurable:!0,enumerable:!0,writable:!0},get:{value:function(t,e,r){var o=n.request(t,e,r);return o.end(),o},configurable:!0,enumerable:!0,writable:!0}})})),e}function x(){}function k(t){var e;if(R)e=new p(t);else if(!I((e=j(c.parse(t))).protocol))throw new b({input:t});return e}function j(t){if(/^\[/.test(t.hostname)&&!/^\[[:0-9a-f]+\]$/i.test(t.hostname))throw new b({input:t.href||t});if(/^\[/.test(t.host)&&!/^\[[:0-9a-f]+\](:\d+)?$/i.test(t.host))throw new b({input:t.href||t});return t}function U(t,e){var r=e||{};for(var o of v)r[o]=t[o];return r.hostname.startsWith("[")&&(r.hostname=r.hostname.slice(1,-1)),""!==r.port&&(r.port=Number(r.port)),r.path=r.search?r.pathname+r.search:r.pathname,r}function A(t,e){var r;for(var o in e)t.test(o)&&(r=e[o],delete e[o]);return null==r?void 0:String(r).trim()}function D(t,e,r){function o(r){N(Error.captureStackTrace)&&Error.captureStackTrace(this,this.constructor),Object.assign(this,r||{}),this.code=t,this.message=this.cause?e+": "+this.cause.message:e}return o.prototype=new(r||Error),Object.defineProperties(o.prototype,{constructor:{value:o,enumerable:!1},name:{value:"Error ["+t+"]",enumerable:!1}}),o}function H(t,e){for(var r of y)t.removeListener(r,g[r]);t.on("error",x),t.destroy(e)}function I(t){return"string"==typeof t||t instanceof String}function N(t){return"function"==typeof t}B.prototype=Object.create(_.prototype),B.prototype.abort=function(){H(this._currentRequest),this._currentRequest.abort(),this.emit("abort")},B.prototype.destroy=function(t){return H(this._currentRequest,t),T.call(this,t),this},B.prototype.write=function(t,e,r){if(this._ending)throw new L;if(!I(t)&&("object"!=typeof(o=t)||!("length"in o)))throw new TypeError("data should be a string, Buffer or Uint8Array");var o;N(e)&&(r=e,e=null),0!==t.length?this._requestBodyLength+t.length<=this._options.maxBodyLength?(this._requestBodyLength+=t.length,this._requestBodyBuffers.push({data:t,encoding:e}),this._currentRequest.write(t,e,r)):(this.emit("error",new q),this.abort()):r&&r()},B.prototype.end=function(t,e,r){if(N(t)?(r=t,t=e=null):N(e)&&(r=e,e=null),t){var o=this,s=this._currentRequest;this.write(t,e,(function(){o._ended=!0,s.end(null,null,r)})),this._ending=!0}else this._ended=this._ending=!0,this._currentRequest.end(null,null,r)},B.prototype.setHeader=function(t,e){this._options.headers[t]=e,this._currentRequest.setHeader(t,e)},B.prototype.removeHeader=function(t){delete this._options.headers[t],this._currentRequest.removeHeader(t)},B.prototype.setTimeout=function(t,e){var r=this;function o(e){e.setTimeout(t),e.removeListener("timeout",e.destroy),e.addListener("timeout",e.destroy)}function s(e){r._timeout&&clearTimeout(r._timeout),r._timeout=setTimeout((function(){r.emit("timeout"),i()}),t),o(e)}function i(){r._timeout&&(clearTimeout(r._timeout),r._timeout=null),r.removeListener("abort",i),r.removeListener("error",i),r.removeListener("response",i),r.removeListener("close",i),e&&r.removeListener("timeout",e),r.socket||r._currentRequest.removeListener("socket",s)}return e&&this.on("timeout",e),this.socket?s(this.socket):this._currentRequest.once("socket",s),this.on("socket",o),this.on("abort",i),this.on("error",i),this.on("response",i),this.on("close",i),this},["flushHeaders","getHeader","setNoDelay","setSocketKeepAlive"].forEach((function(t){B.prototype[t]=function(e,r){return this._currentRequest[t](e,r)}})),["aborted","connection","socket"].forEach((function(t){Object.defineProperty(B.prototype,t,{get:function(){return this._currentRequest[t]}})})),B.prototype._sanitizeOptions=function(t){if(t.headers||(t.headers={}),t.host&&(t.hostname||(t.hostname=t.host),delete t.host),!t.pathname&&t.path){var e=t.path.indexOf("?");e<0?t.pathname=t.path:(t.pathname=t.path.substring(0,e),t.search=t.path.substring(e))}},B.prototype._performRequest=function(){var t=this._options.protocol,e=this._options.nativeProtocols[t];if(!e)throw new TypeError("Unsupported protocol "+t);if(this._options.agents){var r=t.slice(0,-1);this._options.agent=this._options.agents[r]}var o=this._currentRequest=e.request(this._options,this._onNativeResponse);for(var s of(o._redirectable=this,y))o.on(s,g[s]);if(this._currentUrl=/^\//.test(this._options.path)?c.format(this._options):this._options.path,this._isRedirect){var i=0,n=this,h=this._requestBodyBuffers;!function t(e){if(o===n._currentRequest)if(e)n.emit("error",e);else if(i<h.length){var r=h[i++];o.finished||o.write(r.data,r.encoding,t)}else n._ended&&o.end()}()}},B.prototype._processResponse=function(t){var e=t.statusCode;this._options.trackRedirects&&this._redirects.push({url:this._currentUrl,headers:t.headers,statusCode:e});var r,o=t.headers.location;if(!o||!1===this._options.followRedirects||e<300||e>=400)return t.responseUrl=this._currentUrl,t.redirects=this._redirects,this.emit("response",t),void(this._requestBodyBuffers=[]);if(H(this._currentRequest),t.destroy(),++this._redirectCount>this._options.maxRedirects)throw new E;var s=this._options.beforeRedirect;s&&(r=Object.assign({Host:t.req.getHeader("host")},this._options.headers));var i=this._options.method;((301===e||302===e)&&"POST"===this._options.method||303===e&&!/^(?:GET|HEAD)$/.test(this._options.method))&&(this._options.method="GET",this._requestBodyBuffers=[],A(/^content-/i,this._options.headers));var n,h,a=A(/^host$/i,this._options.headers),u=k(this._currentUrl),d=a||u.host,f=/^\w+:/.test(o)?this._currentUrl:c.format(Object.assign(u,{host:d})),_=(n=o,h=f,R?new p(n,h):k(c.resolve(h,n)));if(m("redirecting to",_.href),this._isRedirect=!0,U(_,this._options),(_.protocol!==u.protocol&&"https:"!==_.protocol||_.host!==d&&!function(t,e){l(I(t)&&I(e));var r=t.length-e.length-1;return r>0&&"."===t[r]&&t.endsWith(e)}(_.host,d))&&A(/^(?:(?:proxy-)?authorization|cookie)$/i,this._options.headers),N(s)){var v={headers:t.headers,statusCode:e},y={url:f,method:i,headers:r};s(this._options,v,y),this._sanitizeOptions(this._options)}this._performRequest()},t.exports=O({http:d,https:f}),t.exports.wrap=O;var S=t.exports;export{S as default};
//# sourceMappingURL=index.js.map
