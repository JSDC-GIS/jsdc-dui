{"version":3,"file":"combined_stream.js","sources":["../../../../node_modules/combined-stream/lib/combined_stream.js"],"sourcesContent":["var util = require('util');\nvar Stream = require('stream').Stream;\nvar DelayedStream = require('delayed-stream');\n\nmodule.exports = CombinedStream;\nfunction CombinedStream() {\n  this.writable = false;\n  this.readable = true;\n  this.dataSize = 0;\n  this.maxDataSize = 2 * 1024 * 1024;\n  this.pauseStreams = true;\n\n  this._released = false;\n  this._streams = [];\n  this._currentStream = null;\n  this._insideLoop = false;\n  this._pendingNext = false;\n}\nutil.inherits(CombinedStream, Stream);\n\nCombinedStream.create = function(options) {\n  var combinedStream = new this();\n\n  options = options || {};\n  for (var option in options) {\n    combinedStream[option] = options[option];\n  }\n\n  return combinedStream;\n};\n\nCombinedStream.isStreamLike = function(stream) {\n  return (typeof stream !== 'function')\n    && (typeof stream !== 'string')\n    && (typeof stream !== 'boolean')\n    && (typeof stream !== 'number')\n    && (!Buffer.isBuffer(stream));\n};\n\nCombinedStream.prototype.append = function(stream) {\n  var isStreamLike = CombinedStream.isStreamLike(stream);\n\n  if (isStreamLike) {\n    if (!(stream instanceof DelayedStream)) {\n      var newStream = DelayedStream.create(stream, {\n        maxDataSize: Infinity,\n        pauseStream: this.pauseStreams,\n      });\n      stream.on('data', this._checkDataSize.bind(this));\n      stream = newStream;\n    }\n\n    this._handleErrors(stream);\n\n    if (this.pauseStreams) {\n      stream.pause();\n    }\n  }\n\n  this._streams.push(stream);\n  return this;\n};\n\nCombinedStream.prototype.pipe = function(dest, options) {\n  Stream.prototype.pipe.call(this, dest, options);\n  this.resume();\n  return dest;\n};\n\nCombinedStream.prototype._getNext = function() {\n  this._currentStream = null;\n\n  if (this._insideLoop) {\n    this._pendingNext = true;\n    return; // defer call\n  }\n\n  this._insideLoop = true;\n  try {\n    do {\n      this._pendingNext = false;\n      this._realGetNext();\n    } while (this._pendingNext);\n  } finally {\n    this._insideLoop = false;\n  }\n};\n\nCombinedStream.prototype._realGetNext = function() {\n  var stream = this._streams.shift();\n\n\n  if (typeof stream == 'undefined') {\n    this.end();\n    return;\n  }\n\n  if (typeof stream !== 'function') {\n    this._pipeNext(stream);\n    return;\n  }\n\n  var getStream = stream;\n  getStream(function(stream) {\n    var isStreamLike = CombinedStream.isStreamLike(stream);\n    if (isStreamLike) {\n      stream.on('data', this._checkDataSize.bind(this));\n      this._handleErrors(stream);\n    }\n\n    this._pipeNext(stream);\n  }.bind(this));\n};\n\nCombinedStream.prototype._pipeNext = function(stream) {\n  this._currentStream = stream;\n\n  var isStreamLike = CombinedStream.isStreamLike(stream);\n  if (isStreamLike) {\n    stream.on('end', this._getNext.bind(this));\n    stream.pipe(this, {end: false});\n    return;\n  }\n\n  var value = stream;\n  this.write(value);\n  this._getNext();\n};\n\nCombinedStream.prototype._handleErrors = function(stream) {\n  var self = this;\n  stream.on('error', function(err) {\n    self._emitError(err);\n  });\n};\n\nCombinedStream.prototype.write = function(data) {\n  this.emit('data', data);\n};\n\nCombinedStream.prototype.pause = function() {\n  if (!this.pauseStreams) {\n    return;\n  }\n\n  if(this.pauseStreams && this._currentStream && typeof(this._currentStream.pause) == 'function') this._currentStream.pause();\n  this.emit('pause');\n};\n\nCombinedStream.prototype.resume = function() {\n  if (!this._released) {\n    this._released = true;\n    this.writable = true;\n    this._getNext();\n  }\n\n  if(this.pauseStreams && this._currentStream && typeof(this._currentStream.resume) == 'function') this._currentStream.resume();\n  this.emit('resume');\n};\n\nCombinedStream.prototype.end = function() {\n  this._reset();\n  this.emit('end');\n};\n\nCombinedStream.prototype.destroy = function() {\n  this._reset();\n  this.emit('close');\n};\n\nCombinedStream.prototype._reset = function() {\n  this.writable = false;\n  this._streams = [];\n  this._currentStream = null;\n};\n\nCombinedStream.prototype._checkDataSize = function() {\n  this._updateDataSize();\n  if (this.dataSize <= this.maxDataSize) {\n    return;\n  }\n\n  var message =\n    'DelayedStream#maxDataSize of ' + this.maxDataSize + ' bytes exceeded.';\n  this._emitError(new Error(message));\n};\n\nCombinedStream.prototype._updateDataSize = function() {\n  this.dataSize = 0;\n\n  var self = this;\n  this._streams.forEach(function(stream) {\n    if (!stream.dataSize) {\n      return;\n    }\n\n    self.dataSize += stream.dataSize;\n  });\n\n  if (this._currentStream && this._currentStream.dataSize) {\n    this.dataSize += this._currentStream.dataSize;\n  }\n};\n\nCombinedStream.prototype._emitError = function(err) {\n  this._reset();\n  this.emit('error', err);\n};\n"],"names":["util","require$$0","Stream","require$$1","DelayedStream","require$$2","combined_stream","CombinedStream","this","writable","readable","dataSize","maxDataSize","pauseStreams","_released","_streams","_currentStream","_insideLoop","_pendingNext","inherits","create","options","combinedStream","option","isStreamLike","stream","Buffer","isBuffer","prototype","append","newStream","Infinity","pauseStream","on","_checkDataSize","bind","_handleErrors","pause","push","pipe","dest","call","resume","_getNext","_realGetNext","shift","_pipeNext","end","value","write","self","err","_emitError","data","emit","_reset","destroy","_updateDataSize","message","Error","forEach"],"mappings":"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"}