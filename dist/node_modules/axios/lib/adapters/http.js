import e from"../utils.js";import t from"../core/settle.js";import r from"../core/buildFullPath.js";import o from"../helpers/buildURL.js";import"../../../proxy-from-env/index.js";import s from"http";import n from"https";import a from"util";import i from"../../../follow-redirects/index.js";import c from"zlib";import{VERSION as m}from"../env/data.js";import f from"../defaults/transitional.js";import d from"../core/AxiosError.js";import l from"../cancel/CanceledError.js";import p from"../platform/index.js";import u from"../helpers/fromDataURI.js";import h from"stream";import g from"../core/AxiosHeaders.js";import b from"../helpers/AxiosTransformStream.js";import{EventEmitter as R}from"events";import y from"../helpers/formDataToStream.js";import x from"../helpers/readBlob.js";import E from"../helpers/ZlibHeaderTransformStream.js";import B from"../helpers/callbackify.js";import{progressEventDecorator as w,progressEventReducer as L,asyncDecorator as T}from"../helpers/progressEventReducer.js";import A from"../helpers/estimateDataURLDecodedBytes.js";import{__exports as S}from"../../../../_virtual/index4.js";const _={flush:c.constants.Z_SYNC_FLUSH,finishFlush:c.constants.Z_SYNC_FLUSH},U={flush:c.constants.BROTLI_OPERATION_FLUSH,finishFlush:c.constants.BROTLI_OPERATION_FLUSH},C=e.isFunction(c.createBrotliDecompress),{http:j,https:O}=i,P=/https:?/,D=p.protocols.map((e=>e+":")),v=(e,[t,r])=>(e.on("end",r).on("error",r),t);function N(e,t){e.beforeRedirects.proxy&&e.beforeRedirects.proxy(e),e.beforeRedirects.config&&e.beforeRedirects.config(e,t)}function F(e,t,r){let o=t;if(!o&&!1!==o){const e=S.getProxyForUrl(r);e&&(o=new URL(e))}if(o){if(o.username&&(o.auth=(o.username||"")+":"+(o.password||"")),o.auth){(o.auth.username||o.auth.password)&&(o.auth=(o.auth.username||"")+":"+(o.auth.password||""));const t=Buffer.from(o.auth,"utf8").toString("base64");e.headers["Proxy-Authorization"]="Basic "+t}e.headers.host=e.hostname+(e.port?":"+e.port:"");const t=o.hostname||o.host;e.hostname=t,e.host=t,e.port=o.port,e.path=r,o.protocol&&(e.protocol=o.protocol.includes(":")?o.protocol:`${o.protocol}:`)}e.beforeRedirects.proxy=function(e){F(e,t,e.href)}}const k="undefined"!=typeof process&&"process"===e.kindOf(process),z=(t,r)=>(({address:t,family:r})=>{if(!e.isString(t))throw TypeError("address must be a string");return{address:t,family:r||(t.indexOf(".")<0?6:4)}})(e.isObject(t)?t:{address:t,family:r});var H=k&&function(i){return S=async function(S,k,H){let{data:I,lookup:M,family:q}=i;const{responseType:Q,responseEncoding:Z}=i,K=i.method.toUpperCase();let Y,$,G=!1;if(M){const t=B(M,(t=>e.isArray(t)?t:[t]));M=(r,o,s)=>{t(r,o,((t,r,n)=>{if(t)return s(t);const a=e.isArray(r)?r.map((e=>z(e))):[z(r,n)];o.all?s(t,a):s(t,a[0].address,a[0].family)}))}}const J=new R,V=()=>{i.cancelToken&&i.cancelToken.unsubscribe(W),i.signal&&i.signal.removeEventListener("abort",W),J.removeAllListeners()};function W(e){J.emit("abort",!e||e.type?new l(null,i,$):e)}H(((e,t)=>{Y=!0,t&&(G=!0,V())})),J.once("abort",k),(i.cancelToken||i.signal)&&(i.cancelToken&&i.cancelToken.subscribe(W),i.signal&&(i.signal.aborted?W():i.signal.addEventListener("abort",W)));const X=r(i.baseURL,i.url,i.allowAbsoluteUrls),ee=new URL(X,p.hasBrowserEnv?p.origin:void 0),te=ee.protocol||D[0];if("data:"===te){if(i.maxContentLength>-1){const e=String(i.url||X||"");if(A(e)>i.maxContentLength)return k(new d("maxContentLength size of "+i.maxContentLength+" exceeded",d.ERR_BAD_RESPONSE,i))}let r;if("GET"!==K)return t(S,k,{status:405,statusText:"method not allowed",headers:{},config:i});try{r=u(i.url,"blob"===Q,{Blob:i.env&&i.env.Blob})}catch(e){throw d.from(e,d.ERR_BAD_REQUEST,i)}return"text"===Q?(r=r.toString(Z),Z&&"utf8"!==Z||(r=e.stripBOM(r))):"stream"===Q&&(r=h.Readable.from(r)),t(S,k,{data:r,status:200,statusText:"OK",headers:new g,config:i})}if(-1===D.indexOf(te))return k(new d("Unsupported protocol "+te,d.ERR_BAD_REQUEST,i));const re=g.from(i.headers).normalize();re.set("User-Agent","axios/"+m,!1);const{onUploadProgress:oe,onDownloadProgress:se}=i,ne=i.maxRate;let ae,ie;if(e.isSpecCompliantForm(I)){const e=re.getContentType(/boundary=([-_\w\d]{10,70})/i);I=y(I,(e=>{re.set(e)}),{tag:`axios-${m}-boundary`,boundary:e&&e[1]||void 0})}else if(e.isFormData(I)&&e.isFunction(I.getHeaders)){if(re.set(I.getHeaders()),!re.hasContentLength())try{const e=await a.promisify(I.getLength).call(I);Number.isFinite(e)&&e>=0&&re.setContentLength(e)}catch(e){}}else if(e.isBlob(I)||e.isFile(I))I.size&&re.setContentType(I.type||"application/octet-stream"),re.setContentLength(I.size||0),I=h.Readable.from(x(I));else if(I&&!e.isStream(I)){if(Buffer.isBuffer(I));else if(e.isArrayBuffer(I))I=Buffer.from(new Uint8Array(I));else{if(!e.isString(I))return k(new d("Data after transformation must be a string, an ArrayBuffer, a Buffer, or a Stream",d.ERR_BAD_REQUEST,i));I=Buffer.from(I,"utf-8")}if(re.setContentLength(I.length,!1),i.maxBodyLength>-1&&I.length>i.maxBodyLength)return k(new d("Request body larger than maxBodyLength limit",d.ERR_BAD_REQUEST,i))}const ce=e.toFiniteNumber(re.getContentLength());let me,fe;e.isArray(ne)?(ae=ne[0],ie=ne[1]):ae=ie=ne,I&&(oe||ae)&&(e.isStream(I)||(I=h.Readable.from(I,{objectMode:!1})),I=h.pipeline([I,new b({maxRate:e.toFiniteNumber(ae)})],e.noop),oe&&I.on("progress",v(I,w(ce,L(T(oe),!1,3))))),i.auth&&(me=(i.auth.username||"")+":"+(i.auth.password||"")),!me&&ee.username&&(me=ee.username+":"+ee.password),me&&re.delete("authorization");try{fe=o(ee.pathname+ee.search,i.params,i.paramsSerializer).replace(/^\?/,"")}catch(e){const t=new Error(e.message);return t.config=i,t.url=i.url,t.exists=!0,k(t)}re.set("Accept-Encoding","gzip, compress, deflate"+(C?", br":""),!1);const de={path:fe,method:K,headers:re.toJSON(),agents:{http:i.httpAgent,https:i.httpsAgent},auth:me,protocol:te,family:q,beforeRedirect:N,beforeRedirects:{}};let le;!e.isUndefined(M)&&(de.lookup=M),i.socketPath?de.socketPath=i.socketPath:(de.hostname=ee.hostname.startsWith("[")?ee.hostname.slice(1,-1):ee.hostname,de.port=ee.port,F(de,i.proxy,te+"//"+ee.hostname+(ee.port?":"+ee.port:"")+de.path));const pe=P.test(de.protocol);if(de.agent=pe?i.httpsAgent:i.httpAgent,i.transport?le=i.transport:0===i.maxRedirects?le=pe?n:s:(i.maxRedirects&&(de.maxRedirects=i.maxRedirects),i.beforeRedirect&&(de.beforeRedirects.config=i.beforeRedirect),le=pe?O:j),i.maxBodyLength>-1?de.maxBodyLength=i.maxBodyLength:de.maxBodyLength=1/0,i.insecureHTTPParser&&(de.insecureHTTPParser=i.insecureHTTPParser),$=le.request(de,(function(r){if($.destroyed)return;const o=[r],s=+r.headers["content-length"];if(se||ie){const t=new b({maxRate:e.toFiniteNumber(ie)});se&&t.on("progress",v(t,w(s,L(T(se),!0,3)))),o.push(t)}let n=r;const a=r.req||$;if(!1!==i.decompress&&r.headers["content-encoding"])switch("HEAD"!==K&&204!==r.statusCode||delete r.headers["content-encoding"],(r.headers["content-encoding"]||"").toLowerCase()){case"gzip":case"x-gzip":case"compress":case"x-compress":o.push(c.createUnzip(_)),delete r.headers["content-encoding"];break;case"deflate":o.push(new E),o.push(c.createUnzip(_)),delete r.headers["content-encoding"];break;case"br":C&&(o.push(c.createBrotliDecompress(U)),delete r.headers["content-encoding"])}n=o.length>1?h.pipeline(o,e.noop):o[0];const m=h.finished(n,(()=>{m(),V()})),f={status:r.statusCode,statusText:r.statusMessage,headers:new g(r.headers),config:i,request:a};if("stream"===Q)f.data=n,t(S,k,f);else{const r=[];let o=0;n.on("data",(function(e){r.push(e),o+=e.length,i.maxContentLength>-1&&o>i.maxContentLength&&(G=!0,n.destroy(),k(new d("maxContentLength size of "+i.maxContentLength+" exceeded",d.ERR_BAD_RESPONSE,i,a)))})),n.on("aborted",(function(){if(G)return;const e=new d("stream has been aborted",d.ERR_BAD_RESPONSE,i,a);n.destroy(e),k(e)})),n.on("error",(function(e){$.destroyed||k(d.from(e,null,i,a))})),n.on("end",(function(){try{let t=1===r.length?r[0]:Buffer.concat(r);"arraybuffer"!==Q&&(t=t.toString(Z),Z&&"utf8"!==Z||(t=e.stripBOM(t))),f.data=t}catch(e){return k(d.from(e,null,i,f.request,f))}t(S,k,f)}))}J.once("abort",(e=>{n.destroyed||(n.emit("error",e),n.destroy())}))})),J.once("abort",(e=>{k(e),$.destroy(e)})),$.on("error",(function(e){k(d.from(e,null,i,$))})),$.on("socket",(function(e){e.setKeepAlive(!0,6e4)})),i.timeout){const e=parseInt(i.timeout,10);if(Number.isNaN(e))return void k(new d("error trying to parse `config.timeout` to int",d.ERR_BAD_OPTION_VALUE,i,$));$.setTimeout(e,(function(){if(Y)return;let e=i.timeout?"timeout of "+i.timeout+"ms exceeded":"timeout exceeded";const t=i.transitional||f;i.timeoutErrorMessage&&(e=i.timeoutErrorMessage),k(new d(e,t.clarifyTimeoutError?d.ETIMEDOUT:d.ECONNABORTED,i,$)),W()}))}if(e.isStream(I)){let e=!1,t=!1;I.on("end",(()=>{e=!0})),I.once("error",(e=>{t=!0,$.destroy(e)})),I.on("close",(()=>{e||t||W(new l("Request stream has been aborted",i,$))})),I.pipe($)}else $.end(I)},new Promise(((e,t)=>{let r,o;const s=(e,t)=>{o||(o=!0,r&&r(e,t))},n=e=>{s(e,!0),t(e)};S((t=>{s(t),e(t)}),n,(e=>r=e)).catch(n)}));var S};export{H as default};
//# sourceMappingURL=http.js.map
